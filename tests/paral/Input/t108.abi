# _== Convergency and starting
# DATASET 1: LDA
# DATASET 2: LDA+DMFT
ndtset 3
jdtset 1 2 3

getden1 0
getden  1
getself3 2
nline 5
nline2 10
nnsclo2 10

prtvol    4
pawprtvol 2

##### CONVERGENCE PARAMETERS
nstep1   30
nstep    1
ecut     4 # low cutoff !
pawecutdg 8
tolvrs  1.0d-5
nband     64
nbdbuf    4
occopt 3 tsmear 1200 K

##### PHYSICAL PARAMETERS
natom 5 ntypat 3 typat 1 2 3 3 3
znucl  23.0 38.0 8.0
# V Sr O*3
xred 0.00 0.00 0.00
     0.50 0.50 0.50
     0.50 0.00 0.00
     0.00 0.50 0.00
     0.00 0.00 0.50
acell   3*7.2605
rprim 1.0 0.0 0.0    #Real space PRIMitive translations
      0.0 1.0 0.0
      0.0 0.0 1.0

# == Points k and symetries
ngkpt   2 2 2    #K - PoinTs grid : Real space LATTice
nshiftk 2
shiftk 1/2 1/2 1/2
       0.0 0.0 0.0
istwfk *1

nsppol 1
nspden 4
nspinor 2

# == LDA+DMFT
usedmft1 0
usedmft  1
dmftbandi 9 # include Sr s band
dmftbandf 45 # include V t2g bands
dmft_nwli 500
dmft_iter 1
dmft_mxsf 0.7
dmft_dc 6

dmft_triqs_wmax 1.0

dmft_solv 6 # Rotationally invariant TRIQS

# == DFT+U
usepawu1    0
usepawu     14
dmatpuopt  1   # The density matrix: the simplest expression.
lpawu  2  1 -1
upawu1  0.00  0.0  0.0  eV
f4of2_sla3  0.0  0.0  0.0
upawu   3.1333333333333333  1.0  0.0  eV
jpawu   0.7583333333333333  0.0  0.0  eV

paral_kgb 0

dmftctqmc_meas 100
dmftctqmc_basis 4
dmftqmc_therm 10
dmftqmc_l 500
dmft_triqs_off_diag 0
dmftqmc_n 1.d3

dmft_kspectralfunc 0
dmft_kspectralfunc3 1
iscf3 -2
nbandkss3 20
kssform3  3
tolwfr3 1.d-5
nstep3 5
kptopt3 -1
ndivsm3  20
kptbounds3
        0.0 0.0 0.0      # Gamma
        0.0 1/2 0.0      # N

prtwf 0

 pp_dirpath "$ABI_PSPDIR"
 pseudos "23v.paw, 38sr.paw, 8o.paw"

#%%<BEGIN TEST_INFO>
#%% [setup]
#%% executable = abinit
#%% need_cpp_vars = HAVE_TRIQS_v3_2
#%% [shell]
#%% pre_commands = iw_cp t108o_DS3_spectralfunction_realgrid t108_MPI1o_DS3_spectralfunction_realgrid;
#%%                iw_cp t108o_DS3_spectralfunction_realgrid t108_MPI4o_DS3_spectralfunction_realgrid;
#%%                iw_cp t108o_DS3_spectralfunction_realgrid t108_MPI8o_DS3_spectralfunction_realgrid;
#%%                iw_cp t108i_DS3.UnitaryMatrix_iatom0001   t108_MPI1i_DS3.UnitaryMatrix_iatom0001;
#%%                iw_cp t108i_DS3.UnitaryMatrix_iatom0001   t108_MPI4i_DS3.UnitaryMatrix_iatom0001;
#%%                iw_cp t108i_DS3.UnitaryMatrix_iatom0001   t108_MPI8i_DS3.UnitaryMatrix_iatom0001;
#%%                iw_cp t108i_DS3.UnitaryMatrix_iatom0002   t108_MPI1i_DS3.UnitaryMatrix_iatom0002;
#%%                iw_cp t108i_DS3.UnitaryMatrix_iatom0002   t108_MPI4i_DS3.UnitaryMatrix_iatom0002;
#%%                iw_cp t108i_DS3.UnitaryMatrix_iatom0002   t108_MPI8i_DS3.UnitaryMatrix_iatom0002;
#%%                iw_cp t108i_DS3Self_ra-omega_iatom0001_isppol1 t108_MPI1i_DS3Self_ra-omega_iatom0001_isppol1;
#%%                iw_cp t108i_DS3Self_ra-omega_iatom0001_isppol1 t108_MPI4i_DS3Self_ra-omega_iatom0001_isppol1;
#%%                iw_cp t108i_DS3Self_ra-omega_iatom0001_isppol1 t108_MPI8i_DS3Self_ra-omega_iatom0001_isppol1;
#%%                iw_cp t108i_DS3Self_ra-omega_iatom0002_isppol1 t108_MPI1i_DS3Self_ra-omega_iatom0002_isppol1;
#%%                iw_cp t108i_DS3Self_ra-omega_iatom0002_isppol1 t108_MPI4i_DS3Self_ra-omega_iatom0002_isppol1;
#%%                iw_cp t108i_DS3Self_ra-omega_iatom0002_isppol1 t108_MPI8i_DS3Self_ra-omega_iatom0002_isppol1;
#%% [paral_info]
#%% nprocs_to_test = 1, 4, 8
#%% max_nprocs = 8
#%% [NCPU_1]
#%% files_to_test = t99_MPI4.abo, tolnlines = 0, tolabs = 0.0, tolrel = 0.0;
#%% [NCPU_4]
#%% files_to_test =
#%%   t99_MPI4.abo, tolnlines = 0, tolabs = 0.0, tolrel = 0.0;
#%%   t99_MPI4o_DS2_Wannier_functions_iatom0001_002, tolnlines = 0, tolabs = 0.0, tolrel = 0.0;
#%%   t99_MPI4o_DS2_Wannier_functions_iatom0002_002, tolnlines = 0, tolabs = 0.0, tolrel = 0.0;
#%%   t99_MPI4o_DS2.UnitaryMatrix_iatom0001, tolnlines = 0, tolabs = 0.0, tolrel = 0.0;
#%%   t99_MPI4o_DS2.UnitaryMatrix_iatom0002, tolnlines = 0, tolabs = 0.0, tolrel = 0.0;
#%%   t99_MPI4o_DS2Selfrotformaxent0001_isppol1_iflavor0001, tolnlines = 0, tolabs = 0.0, tolrel = 0.0;
#%%   t99_MPI4o_DS2Selfrotformaxent0002_isppol1_iflavor0001, tolnlines = 0, tolabs = 0.0, tolrel = 0.0;
#%% [NCPU_8]
#%% files_to_test = t99_MPI4.abo, tolnlines = 0, tolabs = 0.0, tolrel = 0.0;
#%% [extra_info]
#%% authors = B. Amadon, E. Castiel
#%% keywords = DMFT, TRIQS
#%% description = DFT+DMFT for SrVO3 using TRIQS with KGB parallelism
#%% topics = DMFT, parallelism
#%%<END TEST_INFO>
