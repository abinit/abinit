# _== Convergency and starting
# DATASET 1: LDA
# DATASET 2: LDA+DMFT
ndtset 2
jdtset 1 2

getden2 1
nline2 5

prtvol    4
pawprtvol 3

##### CONVERGENCE PARAMETERS
nstep1   30
nstep2   2
ecut     4 # low cutoff !
pawecutdg 8

tolvrs1 1.0d-5
toldfe2 1.0d-8
# Added in v9.11:
tolwfr_diago 1d-30
# Default of tolwfr_diago is tolwfr (or, for LOBPCG only, 1d-20 if tolwfr is not defined)
# To reproduce old behaviour : set stringent value of tolwfr_diago
nband     32
nbdbuf    2
occopt 3 tsmear 1200 K

##### PHYSICAL PARAMETERS
natom 5 ntypat 3 typat 1 2 3 3 3
znucl  23.0 38.0 8.0
# V Sr O*3
xred 0.00 0.00 0.00
     0.50 0.50 0.50
     0.50 0.00 0.00
     0.00 0.50 0.00
     0.00 0.00 0.50
acell   3*7.2605
rprim 1.0 0.0 0.0    #Real space PRIMitive translations
      0.0 1.0 0.0
      0.0 0.0 1.0

# == Points k and symetries
ngkpt   2 2 2    #K - PoinTs grid : Real space LATTice
nshiftk 2
shiftk 1/2 1/2 1/2
       0.0 0.0 0.0
istwfk *1

nsppol 2
nspden 2

# == LDA+DMFT
usedmft1 0
usedmft2 1
dmftbandi 5 # include Sr s band
dmftbandf 23 # include V t2g bands
dmft_nwli 500
dmft_iter 1
dmft_mxsf 0.7
dmft_dc 8
dmft_yukawa_param 1

dmft_prtwan 1
dmft_triqs_wmax 1.0

dmft_solv 6 # Density-density TRIQS

# == DFT+U
usepawu1    4
usepawu     14
dmatpuopt  1   # The density matrix: the simplest expression.
lpawu  2  0 -1
upawu1  0.00  0.0  0.0  eV
f4of2_sla3  0.0  0.0  0.0
upawu2  3.1333333333333333  1.0  0.0  eV
jpawu2  0.7583333333333333  0.0  0.0  eV

paral_kgb1 0
paral_kgb2 1
np_spkpt2 4
npband2 2
npfft2 1
bandpp2 16

dmftctqmc_meas 100
dmftctqmc_basis 3
dmftqmc_therm 10
dmftqmc_l 500
dmft_triqs_off_diag 0
dmftqmc_n 1.d3

dmft_orbital -1 -1  1
dmft_orbital_filepath  "t99"

dmft_triqs_entropy 1
dmft_triqs_compute_integral 1
dmft_triqs_gaussorder 2
dmft_triqs_nsubdivisions 2

dmft_triqs_seed_a  33543
dmft_triqs_seed_b  95321
dmft_fermi_step 0.01
dmft_charge_prec 1.d-4
dmft_triqs_epsilon 1.d-5
dmft_shiftself  1.d-1 2.d-1 0.0 0.0 0.0

prtwf 0

 pp_dirpath "$ABI_PSPDIR"
 pseudos "23v.paw, 38sr.paw, 8o.paw"

#%%<BEGIN TEST_INFO>
#%% [setup]
#%% executable = abinit
#%% need_cpp_vars = HAVE_TRIQS_v3_2
#%% [shell]
#%% pre_commands = iw_cp t99_0001 . ; iw_cp t99_0002 .;
#%% [paral_info]
#%% nprocs_to_test = 8
#%% max_nprocs = 8
#%% [NCPU_8]
#%% files_to_test =
#%%   t99_MPI8.abo, tolnlines = 0, tolabs = 0.0, tolrel = 0.0;
#%%   t99_MPI8o_DS2_UnitaryMatrix_iatom0001, tolnlines = 0, tolabs = 0.0, tolrel = 0.0;
#%%   t99_MPI8o_DS2_UnitaryMatrix_iatom0002, tolnlines = 0, tolabs = 0.0, tolrel = 0.0;
#%%   t99_MPI8o_DS2_Selfrotformaxent0001_isppol1_iflavor0001, tolnlines = 0, tolabs = 0.0, tolrel = 0.0;
#%%   t99_MPI8o_DS2_Selfrotformaxent0002_isppol1_iflavor0001, tolnlines = 0, tolabs = 0.0, tolrel = 0.0;
#%%   t99_MPI8o_DS2_Wannier_functions_iatom0001_002, tolnlines = 0, tolabs = 0.0, tolrel = 0.0;
#%%   t99_MPI8o_DS2_Wannier_functions_iatom0002_002, tolnlines = 0, tolabs = 0.0, tolrel = 0.0;
#%%   t99_MPI8o_DS2_DMFTORBITAL_itypat0001.dat, tolnlines = 0, tolabs = 0.0, tolrel = 0.0;
#%%   t99_MPI8o_DS2_DMFTORBITAL_itypat0002.dat, tolnlines = 0, tolabs = 0.0, tolrel = 0.0;
#%% [extra_info]
#%% authors = B. Amadon, E. Castiel
#%% keywords = DMFT, TRIQS
#%% description = DFT+DMFT for SrVO3 using TRIQS with KGB parallelism
#%% topics = DMFT, parallelism
#%%<END TEST_INFO>
