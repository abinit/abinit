# GW calculation for C in the diamond structure (reads SCR and SUSC files generated by t536)
# Dataset 1: Sigma calculation starting from SCR file.
# Dataset 2: Sigma calculation starting from SUSC file.
#
ndtset    3
gwpara    2
enunit    1

# Definition of k-points
ngkpt    2 2 2
nshiftk  4
shiftk   0.0 0.0 0.0  # This grid contains the Gamma point
         0.0 0.5 0.5
         0.5 0.0 0.5
         0.5 0.5 0.0
istwfk    *1           # Option needed for Gamma

optdriver  4      # Self-Energy calculation
symsigma   1
irdwfk     1      # Obtain WFK file from dataset 1

nband      20     # Bands to be used in the Self-Energy calculation
ecutwfn    8.0    # Planewaves to be used to represent the wavefunctions
ecuteps    4.0
ecutsigx   4.0    # Dimension of the G sum in Sigma_x
                  # (the dimension in Sigma_c is controlled by ecuteps)

gw_icutcoul   3  # old deprecated value of icutcoul, only used for legacy
# Dataset1: Calculation of the Self-Energy matrix elements (GW corrections)
irdscr1        1       # Read input SCR file.

# Dataset1: Calculation of the Self-Energy matrix elements (GW corrections)
irdsuscep2     1       # Read input SUSC file, then calculate e^{-1}
gwgamma2       1       # Construct TESTELECTRON W using ALDA TDDFT Kernel.

#Dataset3: QP-SCGW, read QPS file generated by t536
gwcalctyp3    28
symsigma3      0       # Cannot use symmetries.
irdscr3        1       # Read input SCR file.
irdqps3        1

nkptgw     6               # number of k-point where to calculate the GW correction
kptgw
-2.50000000E-01 -2.50000000E-01  0.00000000E+00
-2.50000000E-01  2.50000000E-01  0.00000000E+00
 5.00000000E-01  5.00000000E-01  0.00000000E+00
-2.50000000E-01  5.00000000E-01  2.50000000E-01
 5.00000000E-01  0.00000000E+00  0.00000000E+00
 0.00000000E+00  0.00000000E+00  0.00000000E+00

bdgw  1  8  # calculate GW corrections for bands from 4 to 5
      1  8
      1  8
      1  8
      1  8
      1  8

# Definition of the unit cell: fcc
acell 3*6.7406530878521345  #Same parameters as Shiskin
rprim  0.0  0.5  0.5        #FCC primitive vectors (to be scaled by acell)
       0.5  0.0  0.5
       0.5  0.5  0.0

# Definition of the atom types
ntypat  1
znucl   6

# Definition of the atoms
natom 2           # There are two atoms
typat  1 1
xred              # Reduced coordinate of atoms
       0.0   0.0   0.0
       0.25  0.25  0.25

# Definition of the planewave basis set (at convergence 16 Rydberg 8 Hartree)
ecut 8.0          # Maximal kinetic energy cut-off, in Hartree


 pp_dirpath "$ABI_PSPDIR"
 pseudos "PseudosTM_pwteter/6c.pspnc"

#%%<BEGIN TEST_INFO>
#%% [setup]
#%% executable = abinit
#%% test_chain = t04.abi, t05.abi
#%% [files]
#%% files_to_test = 
#%%   t05.abo, tolnlines = 10, tolabs = 1.1e-3, tolrel = 4.0e-2, fld_options =  -medium
#%% [paral_info]
#%% max_nprocs = 6
#%% [extra_info]
#%% authors = M. Giantomassi
#%% keywords =  GW, NC
#%% description = 
#%%  Carbon in diamond structure. Chained GW calculation: The first run produces the KSS, the SCR, the SUSC
#%%  and the QPS file. These file are subsequently read and used in t537 using irdwfk, irdscr, irdsuscep and irdqps
#%%  In the second dataset of t85, the screened interaction W is approximated using the test-electron
#%%  expression with the TDDFT ALDA kernel (gwgamma==1).
#%%<END TEST_INFO>
