# GWPT calculation with SCR file
# Preparatory run for computing the ZPR

 #gwpt_np_wpqbks 1 1 8 1 1 1
 optdriver 7              # Enter EPH driver.
 eph_task 17              # GWPT computation.

 # When computing <k+q,m|\Delta_{q pert} V_scf|n, k>
 # we want k in the IBZ and q in the full BZ.
 gstore_kzone "ibz"
 gstore_qzone "bz"
 #gstore_use_lgk 1

 # Additional filter in k-space: only k-points corresponding to the band edges are considered
 gstore_kfilter "qprange"

 # store complex g matrix elements in the atomic representation in the GSTORE file.
 gstore_gmode "atom"
 gstore_cplex 2

 ecut 45.0          # Cutoff energy for wavefunctions.
 ecuteps  8         # Cutoff energy for screening (cannot be larger than the one found in the SCR file)
                    # SC TODO: on alps_gnu_14.2_cov, ecuteps here = ecuteps in the SCR file still results in an error

 ecutsigx 8         # Cutoff energy for exchange part.
 boxcutmin 1.1
 tolwfr 1e-4

 nband 9           # Number of bands to build G with Lehmnann's representation.
                   # This value cannot be larger that the number of bands in the WFK file.
 #prtvol 10

 # TODO: Should have a default value
 elph2_imagden 0.1 eV

 # Specify ppmodel used to evalue convolution between G and W.
 # MG: TODO: ppmodel 2 leads to a SIGFPE on eos_gnu_13.2_mpich
 #ppmodel 2

 # Read wavefunctions from this file
 getwfk_filepath "t03o_WFK"

 # K-mesh (must be equal to the one of the WFK file).
 ngkpt 2 2 2
 nshiftk 1
 shiftk 0 0 0

 # We also need the KS GS density and potential.
 getden_filepath "diamond_eph_gwpt/gso_DEN.nc"
 getpot_filepath "diamond_eph_gwpt/gso_POT.nc"

 # Read DDB file with dynamica matrix.
 getddb_filepath "diamond_eph_gwpt/out_DDB"
 ddb_ngqpt 2 2 2          # The code expects to find in the DDB
                          # all the IBZ q-points corresponding to a 2x2x2 q-mesh

 # Read first-order potentials and densities from these two files.
 getdvdb_filepath "t01_DVDB"
 getdrhodb_filepath "t02_DRHODB"

 # Read Screening from this file.
 getscr_filepath "diamond_eph_gwpt/gwo_SCR.nc"

 # Disable output of phonon DOS and phonon bands.
 prtphdos 0
 prtphbands 0

##############################################
####                 SECTION: Sigma_nk
##############################################
 zcut 0.01 eV

# Read crystal structure from DEN.nc file
 structure "abifile:diamond_eph_gwpt/gso_DEN.nc"

 pp_dirpath "$ABI_PSPDIR/Psdj_nc_fr_04_pbe_std_psp8"
 pseudos "C.psp8"

##############################################################
# This section is used only for regression testing of ABINIT #
##############################################################
#%%<BEGIN TEST_INFO>
#%% [setup]
#%% executable = abinit
#%% exclude_builders = eos_nvhpc_23.9_elpa, eos_nvhpc_24.9_openmpi
#%% test_chain = t01.abi, t02.abi, t03.abi, t04.abi
#%% [files]
#%% use_git_submodule = diamond_eph_gwpt
#%% files_to_test =
#%%   t04.abo, tolnlines= 700, tolabs= 1.0e+5, tolrel= 10.0
#%% [paral_info]
#%% max_nprocs = 10
#%% [extra_info]
#%% authors = M. Giantomassi
#%% keywords = NC, DFPT, EPH
#%% description = GWPT calculation
#%%<END TEST_INFO>
