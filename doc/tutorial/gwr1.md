---
authors: MG
---

# First tutorial on GWR (GW in real-space and imaginary time)

## The quasi-particle band structure of Silicon in the one-shot GW approximation.

This tutorial aims at showing how to calculate self-energy corrections to the
DFT Kohn-Sham (KS) eigenvalues in the one-shot GW approximation using the GWR code

The user should be familiarized with the four basic tutorials of ABINIT,
see the [tutorial home page](/tutorial),
and is strongly encouraged to read the [introduction to the GWR code](/tutorial/gwr_intro)
before running these examples.

This tutorial should take about 2 hours.

[TUTORIAL_README]

### Ground-state and band structure

*Before beginning, you might consider creating a different subdirectory to work in. Why not create Work_gwr?*

The file *tgwr_1.abi* is the input file for the first step:
a SCF run followed by a NSCF band structure calculation along a high-symmetry $\kk$-path.
Copy it to the working directory with:

```sh
mkdir Work_gwr
cd Work_gwr
cp ../tgwr_1.abi .
```

You may want to immediately start the job in background with:

```sh
abinit tgwr_1.abi > tgwr_1.log 2> err &
```

so that we have some time to discuss the input while ABINIT is running.

{% dialog tests/tutorial/Input/tgwr_1.abi %}

The first dataset produces the density file that is then used to compute
the band structure in the second dataset.
Since all the input files of this tutorial use the same crystalline structure, pseudos and [[ecut]],
we declare these variables in an external file that will be included in all the other input files
using the syntax:

```
# Include geometry and pseudos
include "gwr_include.abi"
```

If you open the include file:

{% dialog tests/tutorial/Input/gwr_include.abi %}

you will notice that we are using norm-conserving pseudos taken from the standard scalar-relativistic table of the PseudoDojo.
For GW calculations, we strongly recommend using pseudos from the stringent table
as they have closed-shells treated as valence that are important for a correct description of exchange effects [[cite:Setten2018]].
In the case of silicon, there is no difference between the standard version and the stringent version of the pseudo,
but if we consider Ga, you will see that the stringent version includes the 3spd states in valence while the standard pseudos
only the 3d states.
Since we are using scalar-relativistic (SR) pseudos, we cannot treat SOC and [[nspinor]] must be 1 (default).
To include SOC, one should use fully-relativistic (FR) pseudos and use [[nspinor]] 2 in all the input files
and select the appropriate value of [[nspden]] (4 or 1) depending on whether the system is magnetic or not.

For efficiency reasons, we are using underconverged parameters:
the cutoff energy [[ecut]] is XXX that is slightly smaller that the recommended value reported in the PseudoDojo table
Also, the density is computed with 2x2x2 $\Gamma$-centered $\kk$-mesh.
In real life, one should compute the KS density with a much denser mesh so that we have an accurate density
to compute KS states and eigenvalues for the GWR part.

At this point, the calculation should have completed and
we can have a look at the electronic band structure to understand
the position of the band edges.

!!! tip

    If |AbiPy| is installed on your machine, you can use the |abiopen| script
    with the `--expose` option to visualize the band structure from the GSR.nc file:

        abiopen.py tgwr_1o_DS2_GSR.nc --expose

    ![](base1_assets/abiopen_tgwr1_1.png)

    To print the results to terminal, use:

        abiopen.py tgwr_1o_DS2_GSR.nc -p


Silicon is an indirect band gap semiconductor:
The CBM is located at the $\Gamma$ point
The KS fundamental band gap is XXX that is strongly underestimated wrt experiment.

!!! important

    Similarly to the conventional GW code, also GWR can compute QP corrections only
    for the $\kk$-points belonging to the mesh used to generate the WFK file.
    Before running GW calculations is always a good idea to analyze carefully the KS band
    structure to understand the location of the band edges and select the most appropriate $\kk$-mesh.


### Generation of the WFK file with empty states

In the second input file, we use the density computed previously (tgwr\_1o\_DS1\_DEN)
to generate two WFK files with two different $\Gamma$-centered $\kk$-meshes ([[ngkpt]] = 2x2x2 and 4x4x4)
so that we can perform convergence studies wrt the BZ sampling in the last part of this tutorial.

Start the job in background with:

```sh
abinit tgwr_2.abi > tgwr_2.log 2> err &
```

{% dialog tests/tutorial/Input/tgwr_2.abi %}

Note that here we are using [[gwr_task]] = "HDIAGO" to perform a **direct diagonalization**
of the KS Hamiltonian constructed from the DEN file.
This procedure differs from the one used in the other GW tutorials in which the WFK file
is generated by performing an **iterative diagonalization** in which only the applications of the Hamiltoniana is required.
The reason is that the direct diagonalization outperforms iterative methods when many empty states are required,
especially if one can take advantage of ScalaPack to distribute the Hamiltonian matrix.

Here we ask for 100 states as in the previous GW tutorial [[nband]] = 100 was considered converged within 30 meV.
Cleary, when studying new systems a good value of [[nband]] is not given to you
so one has to plan this calculation in advance and ask for a reasonably-large number of states
so that we do not have to repeat the WFK generation several times just to increase the number of bands.

!!! important

    The direct diagonalization is MPI-parallelized across three different levels:
    collinear spin $\sigma$ (not used here), $\kk$-points and scalapack distribution of the $H^\sigma_\kk(\bg,\bg')$ matrix.
    Abinit will try to find an optimal distribution of the workload at runtime yet there are a couple
    of things worth keeping in mind when choosing the number of MPI processes for this step.
    Ideally the total number of cores should be a multiple of [[nkpt]] * [[nsppol]] to avoid load imbalance.

    In order to compute **all** the eigenvectors of the KS Hamiltonian, one can use gwr_task "HDIAGO_FULL".
    In this case the value of [[nband]] is automatically set to the total number of plawewaves
    for that particular $\kk$-point.
    No stopping criterion such as [[tolwfr]] or the number of iterations [[nstep]] are required when Scalapack is used.


### Our first GWR calculation

For our first GWR run, we use a minimalistic input file that
performs a GWR calculation using the DEN and the WFK file produced previously.
First of all, you may want to start immediately the computation by issuing:

```sh
abinit tgwr_3.abi > tgwr_3.log 2> err &
```

with the following input file:

{% dialog tests/tutorial/Input/tgwr_3.abi %}

The input file contains some variables that have the same meaning as in the conventional GW code
and other variables that are specific to GWR.

We use [[optdriver]] 6 to enter the GWR code and [[gwr_task]] activates a one-shot calculation.
We ask for a minimax mesh with [[gwr_ntau]] = 6 points.
This is the minimum number of points one can use at present, and, clearly, it should be subject to convergence studies.

[[getden_filepath]] specifies the density file used to compute $v_{xc}(\rr)$,
while [[getwfk_filepath]] specifies the WFK file with empty states.
Note that the $\kk$-mesh specified in the input via [[ngkpt]], [[nshiftk]] and [[shiftk]] must
agree with the one found in the WFK file.

[[gwr_boxcutmin]] is set to 1.1 in order to accelerate the calculation,
This is one of the parameters that should be subject to convergence studies.
Please take some time to read the variable description.

Now, let us turn our attention to the variables that are also used in the legacy GW code.
In the [first GW tutorial](/tutorial/gw1), we have already performed convergence studies,
and we found that [[nband]] = 100 can be considered converged within 30 mev, which is fair to compare with experimental accuracy.
Also ecuteps = 6.0 can be considered converged within 10 meV.
We will not repeat these convergence studies here and we just use these values for our calculation so that
we can focus on the analysis of the output file and the post-processing of the results.

The cutoff of the polarizability and $W$ is defined by [[ecuteps]] as in the conventional GW code
The cutoff for the exchange part of the self-energy is defined by [[ecutsigx]].
Theoretically, we need [[ecutsigx]] = 4 [[ecut]] to have an exact treatment of $\Sigma_x$.
The computation of the exchange is relatively fast as only occupied states are involved.

The $\kk$-points and the band range for the QP corrections can be specified in different ways.
Here we set them explicitly using [[nkptgw]], [[kptgw]] and [[bdgw]]

Explicitly via
Implicitly via [[gw_qprange]]

For the spectral function, we have the following variables [[nfreqsp]], [[freqspmax]]

[[inclvkb]] == 2, [[symsigma]]

We can now have a look at the main output file:

{% dialog tests/tutorial/Refs/tgwr_3.abo %}

First of all, we find a section that summarizes


The most important GWR parameters are summarized in this Yaml document

```yaml
--- !GWR_params
iteration_state: {dtset: 1, }
gwr_task: G0W0
nband: 100
ntau: 6
ngkpt: [2, 2, 2, ]
ngqpt: [2, 2, 2, ]
chi_algo: supercell
sigma_algo: 'BZ-convolutions'
nkibz: 3
nqibz: 3
inclvkb: 2
q0: [  1.00000000E-05,   2.00000000E-05,   3.00000000E-05, ]
gw_icutcoul: 6
green_mpw: 412
tchi_mpw: 190
g_ngfft: [12, 12, 12, 12, 12, 12, ]
gwr_boxcutmin:   1.10000000E+00
P gwr_np_kgts: [1, 1, 1, 1, ]
P np_kibz: [1, 1, 1, ]
P np_qibz: [1, 1, 1, ]
min_transition_energy_eV:   2.20247744E-02
max_transition_energy_eV:   3.84181232E+00
eratio:   1.74431404E+02
ft_max_err_t2w_cos:   3.39269547E-02
ft_max_err_w2t_cos:   4.27492521E-03
ft_max_err_t2w_sin:   1.00974389E+00
cosft_duality_error:   4.08855664E-04
Minimax imaginary tau/omega mesh: !Tabular | # tau, weight(tau), omega, weight(omega)
    1 1.16987E-01   3.20191E-01   8.71836E-03   1.84660E-02
    2 8.20298E-01   1.25063E+00   3.30978E-02   3.36974E-02
    3 3.19454E+00   3.95048E+00   8.75746E-02   8.49211E-02
    4 1.01456E+01   1.10178E+01   2.40282E-01   2.55119E-01
    5 2.85210E+01   2.82127E+01   7.50121E-01   9.22624E-01
    6 7.50861E+01   7.27575E+01   2.97572E+00   4.74388E+00
...
```

Finally, we have the section with the QP results in eV units

```
================================================================================
 QP results (energies in eV)
 Notations:
     E0: Kohn-Sham energy
     <VxcDFT>: Matrix elements of Vxc[n_val] without non-linear core correction (if any)
     SigX: Matrix elements of Sigma_x
     SigC(E0): Matrix elements of Sigma_c at E0
     Z: Renormalization factor
     E-E0: Difference between the QP and the KS energy.
     E-Eprev: Difference between QP energy at iteration i and i-1
     E: Quasi-particle energy
     Occ(E): Occupancy of QP state



--- !GWR_SelfEnergy_ee
iteration_state: {dtset: 1, }
kpoint     : [   0.000,    0.000,    0.000, ]
spin       : 1
gwr_scf_iteration: 1
gwr_task   : G0W0
QP_VBM_band: 4
QP_CBM_band: 5
KS_gap     :    2.433
QP_gap     :    3.401
Delta_QP_KS:    0.969
data: !Tabular |
     Band       E0 <VxcDFT>     SigX SigC(E0)        Z     E-E0  E-Eprev        E   Occ(E)
        2   -0.300  -11.415  -13.532    1.594    0.860   -0.447   -0.447   -0.746    2.000
        3   -0.300  -11.415  -13.532    1.594    0.860   -0.447   -0.447   -0.746    2.000
        4   -0.300  -11.415  -13.532    1.594    0.860   -0.447   -0.447   -0.746    2.000
        5    2.133   -9.958   -4.937   -4.393    0.834    0.522    0.522    2.655    0.000
        6    2.133   -9.958   -4.937   -4.393    0.834    0.522    0.522    2.655    0.000
        7    2.133   -9.958   -4.937   -4.393    0.834    0.522    0.522    2.655    0.000
...
```

The meaning of the different columns should be self-explanatory.


### Convergence study

As discussed in [[cite:Setten2017]], the convergence study for the $\kk$-mesh, the number
of bands and the cutoff energies can be decoupled in the sense that one can start from
a reasonaby coarse $\kk$-mesh to find the converged values of [[nband]], [[ecuteps]], [[ecutsigx]]
and then fix these values and look at the convergence with respect to the BZ mesh.

The recomended procedure to converge GWR calculations is as follows.

In the first step, we suggest fixing the [[ngkpt]] $\kk$-mesh in the WFK file
as well as [[gwr_ntau]] and perform a convergence studies with respect to [[nband]] and [[ecuteps]].
Note that [[gwr_ntau]] = 6 may be too small and give unphysical results.

After this step, one should start to converge with respect to
[[gwr_boxcutmin]],

Next one should start to increase [[gwr_ntau]].
Finally, one can start to monitor the convergence with the BZ sampling.


!!! important

    We strongly recommend avoiding multidatasets for these kind of calculations.
